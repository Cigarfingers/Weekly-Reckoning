<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Discord Darts League - The Weekly Reckoning</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    .admin-only { display: none; }
    .is-admin .admin-only { display: block; }
    .is-admin .admin-button { display: inline-flex; }
    .admin-button { display: none; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Admin Login Modal -->
  <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-96">
      <h2 class="text-xl font-bold mb-4">Admin Login</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">Password:</label>
          <input type="password" id="adminPassword" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Enter admin password"/>
        </div>
        <div class="flex gap-2">
          <button onclick="login()" class="flex-1 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Login</button>
          <button onclick="viewOnly()" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">View Only</button>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-6xl mx-auto p-6">
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <div class="flex items-center justify-center mb-6">
        <div class="text-center">
          <div class="w-24 h-24 mx-auto mb-4 bg-blue-500 rounded-full flex items-center justify-center text-white text-4xl font-bold">DDL</div>
          <h1 class="text-4xl font-bold text-gray-800 mb-2">The Weekly Reckoning</h1>
          <p class="text-lg text-gray-600">Discord Darts League Championship</p>
        </div>
      </div>

      <!-- Admin Controls -->
      <div class="admin-only flex flex-wrap gap-4 mb-6">
        <div class="flex items-center gap-2">
          <label class="font-medium">Week:</label>
          <select id="weekSelect" onchange="setCurrentWeek(this.value)" class="border border-gray-300 rounded px-3 py-2">
            <option value="1">Week 1</option><option value="2">Week 2</option><option value="3">Week 3</option>
            <option value="4">Week 4</option><option value="5">Week 5</option><option value="6">Week 6</option><option value="7">Week 7</option>
          </select>
        </div>

        <label class="flex items-center gap-2 bg-blue-500 text-white px-4 py-2 rounded cursor-pointer hover:bg-blue-600">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>
          Import CSV
          <input type="file" accept=".csv" onchange="handleCSVImport(event)" class="hidden"/>
        </label>

        <button onclick="exportCSV()" class="flex items-center gap-2 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z"/></svg>
          Export CSV
        </button>

        <button onclick="clearAllData()" class="flex items-center gap-2 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M12,6V9L16,5L12,1V4A8,8 0 0,0 4,12C4,13.57 4.46,15.03 5.24,16.26L6.7,14.8C6.25,13.97 6,13 6,12A6,6 0 0,1 12,6M18.76,7.74L17.3,9.2C17.74,10.04 18,11 18,12A6,6 0 0,1 12,18V15L8,19L12,23V20A8,8 0 0,0 20,12C20,10.43 19.54,8.97 18.76,7.74Z"/></svg>
          Clear All
        </button>

        <button onclick="logout()" class="flex items-center gap-2 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Logout</button>
      </div>

      <!-- Week Data Entry (Admin Only) -->
      <div id="weekDataEntry" class="admin-only grid md:grid-cols-2 gap-6 mb-8">
        <div class="space-y-4">
          <h3 class="text-xl font-semibold">Week <span id="currentWeekDisplay">1</span> Results</h3>

          <!-- Tournament Winner -->
          <div>
            <label class="block font-medium mb-1">Tournament Winner (7 points)</label>
            <input type="text" id="winner" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Enter winner name"/>
          </div>

          <!-- Tournament Runner Up -->
          <div>
            <label class="block font-medium mb-1">Tournament Runner Up (5 points)</label>
            <input type="text" id="runnerUp" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Enter runner up name"/>
          </div>

          <!-- Tournament Semi Finalists -->
          <div>
            <label class="block font-medium mb-1">Tournament Losing Semi Finalists (3 points each)</label>
            <div id="semiFinalists">
              <div class="flex gap-2 mb-2">
                <input type="text" class="flex-1 border border-gray-300 rounded px-3 py-2" placeholder="Semi finalist 1"/>
                <button onclick="removeSemiFinalist(this)" class="text-red-500 hover:text-red-700">
                  <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>
                </button>
              </div>
              <div class="flex gap-2 mb-2">
                <input type="text" class="flex-1 border border-gray-300 rounded px-3 py-2" placeholder="Semi finalist 2"/>
                <button onclick="removeSemiFinalist(this)" class="text-red-500 hover:text-red-700">
                  <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>
                </button>
              </div>
            </div>
            <button onclick="addSemiFinalist()" class="flex items-center gap-1 text-blue-500 hover:text-blue-700">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg>
              Add Semi Finalist
            </button>
          </div>

          <!-- Highest Checkout (multi) -->
          <div>
            <label class="block font-medium mb-1">Highest Checkout (+2 points each)</label>
            <div id="highestCheckouts">
              <div class="flex gap-2 mb-2">
                <input type="text" class="flex-1 border border-gray-300 rounded px-3 py-2" placeholder="Highest checkout 1"/>
                <button onclick="removeHighestCheckouts(this)" class="text-red-500 hover:text-red-700">
                  <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>
                </button>
              </div>
            </div>
            <button onclick="addHighestCheckouts()" class="flex items-center gap-1 text-blue-500 hover:text-blue-700">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg>
              Add Player
            </button>
          </div>
        </div>

        <div class="space-y-4">
          <!-- Group Winners -->
          <div>
            <label class="block font-medium mb-1">Group Winners (+3 points each)</label>
            <div id="groupWinners">
              <div class="flex gap-2 mb-2">
                <input type="text" class="flex-1 border border-gray-300 rounded px-3 py-2" placeholder="Group winner 1"/>
                <button onclick="removeGroupWinner(this)" class="text-red-500 hover:text-red-700">
                  <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>
                </button>
              </div>
            </div>
            <button onclick="addGroupWinner()" class="flex items-center gap-1 text-blue-500 hover:text-blue-700">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg>
              Add Group Winner
            </button>
          </div>

          <!-- Group Runners Up -->
          <div>
            <label class="block font-medium mb-1">Group Runners Up (+2 points each)</label>
            <div id="groupRunnersUp">
              <div class="flex gap-2 mb-2">
                <input type="text" class="flex-1 border border-gray-300 rounded px-3 py-2" placeholder="Group runner up 1"/>
                <button onclick="removeGroupRunnerUp(this)" class="text-red-500 hover:text-red-700">
                  <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>
                </button>
              </div>
            </div>
            <button onclick="addGroupRunnerUp()" class="flex items-center gap-1 text-blue-500 hover:text-blue-700">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg>
              Add Group Runner Up
            </button>
          </div>

          <!-- Third/Fourth in Group (1 point only if eliminated next round) -->
          <div>
            <label class="block font-medium mb-1">3rd/4th in Group - Eliminated Next Round (1 point each)</label>
            <div id="thirdFourthEliminated">
              <div class="flex gap-2 mb-2">
                <input type="text" class="flex-1 border border-gray-300 rounded px-3 py-2" placeholder="Player eliminated after group"/>
                <button onclick="removeThirdFourthEliminated(this)" class="text-red-500 hover:text-red-700">
                  <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>
                </button>
              </div>
            </div>
            <button onclick="addThirdFourthEliminated()" class="flex items-center gap-1 text-blue-500 hover:text-blue-700">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg>
              Add Player
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- League Table -->
    <div class="bg-white rounded-lg shadow-lg p-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">League Table</h2>
      <div id="leagueTable" class="overflow-x-auto">
        <p class="text-gray-500 text-center py-8">No data entered yet.</p>
      </div>

      <!-- Points Legend -->
      <div class="mt-6 p-4 bg-gray-50 rounded-lg">
        <h3 class="font-semibold mb-2">Points System:</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
          <div><strong>Tournament Winner:</strong> 7 points</div>
          <div><strong>Tournament Runner Up:</strong> 5 points</div>
          <div><strong>Tournament Semi Finalist:</strong> 3 points</div>
          <div><strong>Group Winner:</strong> +3 points</div>
          <div><strong>Group Runner Up:</strong> +2 points</div>
          <div><strong>3rd/4th in Group (eliminated next):</strong> 1 point</div>
          <div><strong>Highest Checkout:</strong> +2 points</div>
          <div><strong>Attendance Bonus:</strong> +3 points (6+ weeks)</div>
        </div>
        <div class="mt-2 text-xs text-gray-600">
          <p><strong>Note:</strong> Tournament placement points override group elimination points. Example: Win group + win tournament = 9 points total (3+7, not 3+7+1).</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const ADMIN_PASSWORD = "DDLAdmin2024"; // change as needed

    // State
    let weekData = {};
    let currentWeek = 1;
    let isAdmin = false;

    // Point values
    const POINTS = {
      tournamentWinner: 7,
      tournamentRunnerUp: 5,
      tournamentSemiFinal: 3,
      groupWinner: 3,
      groupRunnerUp: 2,
      thirdFourthEliminated: 1,
      highestCheckout: 2,
      attendanceBonus: 3
    };

    // Init
    document.addEventListener('DOMContentLoaded', function () {
      loadData();
      updateUI();
      document.getElementById('loginModal').style.display = 'flex';
    });

    // Auth
    function login() {
      const password = document.getElementById('adminPassword').value;
      if (password === ADMIN_PASSWORD) {
        isAdmin = true;
        document.body.classList.add('is-admin');
        document.getElementById('loginModal').style.display = 'none';
        alert('Admin access granted!');
      } else {
        alert('Incorrect password!');
      }
    }
    function viewOnly() {
      isAdmin = false;
      document.body.classList.remove('is-admin');
      document.getElementById('loginModal').style.display = 'none';
    }
    function logout() {
      isAdmin = false;
      document.body.classList.remove('is-admin');
      document.getElementById('loginModal').style.display = 'flex';
      document.getElementById('adminPassword').value = '';
    }

    // Data management
    function loadData() {
      const saved = localStorage.getItem('tournamentData');
      if (saved) {
        weekData = JSON.parse(saved);

        // Migration: old single "highestCheckout" -> new array "highestCheckouts"
        Object.keys(weekData).forEach((w) => {
          const d = weekData[w];
          if (d && !Array.isArray(d.highestCheckouts)) {
            const val = (d.highestCheckout || '').trim();
            d.highestCheckouts = val ? val.split(',').map(s => s.trim()).filter(Boolean) : [];
            delete d.highestCheckout;
          }
        });
      }
    }

    function saveData() {
      if (isAdmin) {
        saveCurrentWeekData();
        localStorage.setItem('tournamentData', JSON.stringify(weekData));
        updateLeagueTable();
      }
    }

    function saveCurrentWeekData() {
      if (!isAdmin) return;
      const data = {
        winner: document.getElementById('winner').value.trim(),
        runnerUp: document.getElementById('runnerUp').value.trim(),
        semiFinalists: Array.from(document.querySelectorAll('#semiFinalists input')).map(i => i.value.trim()).filter(Boolean),
        groupWinners: Array.from(document.querySelectorAll('#groupWinners input')).map(i => i.value.trim()).filter(Boolean),
        groupRunnersUp: Array.from(document.querySelectorAll('#groupRunnersUp input')).map(i => i.value.trim()).filter(Boolean),
        thirdFourthEliminated: Array.from(document.querySelectorAll('#thirdFourthEliminated input')).map(i => i.value.trim()).filter(Boolean),
        highestCheckouts: Array.from(document.querySelectorAll('#highestCheckouts input')).map(i => i.value.trim()).filter(Boolean)
      };
      weekData[currentWeek] = data;
    }

    function setCurrentWeek(week) {
      if (!isAdmin) return;
      saveCurrentWeekData();
      currentWeek = parseInt(week);
      updateUI();
    }

    function updateUI() {
      document.getElementById('currentWeekDisplay').textContent = currentWeek;
      document.getElementById('weekSelect').value = currentWeek;
      if (isAdmin) loadCurrentWeekData();
      updateLeagueTable();
    }

    function loadCurrentWeekData() {
      const data = weekData[currentWeek] || {
        winner: '',
        runnerUp: '',
        semiFinalists: ['', ''],
        groupWinners: [''],
        groupRunnersUp: [''],
        thirdFourthEliminated: [''],
        highestCheckouts: ['']
      };

      document.getElementById('winner').value = data.winner || '';
      document.getElementById('runnerUp').value = data.runnerUp || '';

      updateInputList('semiFinalists', data.semiFinalists && data.semiFinalists.length ? data.semiFinalists : ['', '']);
      updateInputList('groupWinners', data.groupWinners && data.groupWinners.length ? data.groupWinners : ['']);
      updateInputList('groupRunnersUp', data.groupRunnersUp && data.groupRunnersUp.length ? data.groupRunnersUp : ['']);
      updateInputList('thirdFourthEliminated', data.thirdFourthEliminated && data.thirdFourthEliminated.length ? data.thirdFourthEliminated : ['']);
      updateInputList('highestCheckouts', data.highestCheckouts && data.highestCheckouts.length ? data.highestCheckouts : ['']);
    }

    function updateInputList(containerId, values) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      values.forEach((value, index) => {
        const div = document.createElement('div');
        div.className = 'flex gap-2 mb-2';
        div.innerHTML = `
          <input type="text" value="${value || ''}" class="flex-1 border border-gray-300 rounded px-3 py-2" placeholder="${getPlaceholder(containerId, index)}">
          ${values.length > 1 ? `
            <button onclick="remove${capitalizeFirst(containerId)}(this)" class="text-red-500 hover:text-red-700">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>
            </button>` : '' }
        `;
        container.appendChild(div);
      });
      container.querySelectorAll('input').forEach(input => input.addEventListener('input', saveData));
    }

    function getPlaceholder(containerId, index) {
      const placeholders = {
        semiFinalists: `Semi finalist ${index + 1}`,
        groupWinners: `Group winner ${index + 1}`,
        groupRunnersUp: `Group runner up ${index + 1}`,
        thirdFourthEliminated: `Player eliminated after group`,
        highestCheckouts: `Highest checkout ${index + 1}`
      };
      return placeholders[containerId] || '';
    }

    function capitalizeFirst(str) { return str.charAt(0).toUpperCase() + str.slice(1); }

    // Add/Remove helpers
    function addSemiFinalist() {
      if (!isAdmin) return;
      const container = document.getElementById('semiFinalists');
      const count = container.children.length;
      const div = document.createElement('div');
      div.className = 'flex gap-2 mb-2';
      div.innerHTML = `
        <input type="text" class="flex-1 border border-gray-300 rounded px-3 py-2" placeholder="Semi finalist ${count + 1}">
        <button onclick="removeSemiFinalist(this)" class="text-red-500 hover:text-red-700">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>
        </button>`;
      container.appendChild(div);
      div.querySelector('input').addEventListener('input', saveData);
    }
    function removeSemiFinalist(btn) {
      if (!isAdmin) return;
      const c = document.getElementById('semiFinalists');
      if (c.children.length > 1) { btn.parentElement.remove(); saveData(); }
    }

    function addGroupWinner() {
      if (!isAdmin) return;
      const c = document.getElementById('groupWinners');
      const n = c.children.length;
      const div = document.createElement('div');
      div.className = 'flex gap-2 mb-2';
      div.innerHTML = `
        <input type="text" class="flex-1 border border-gray-300 rounded px-3 py-2" placeholder="Group winner ${n + 1}">
        <button onclick="removeGroupWinner(this)" class="text-red-500 hover:text-red-700">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>
        </button>`;
      c.appendChild(div);
      div.querySelector('input').addEventListener('input', saveData);
    }
    function removeGroupWinner(btn) {
      if (!isAdmin) return;
      const c = document.getElementById('groupWinners');
      if (c.children.length > 1) { btn.parentElement.remove(); saveData(); }
    }

    function addGroupRunnerUp() {
      if (!isAdmin) return;
      const c = document.getElementById('groupRunnersUp');
      const n = c.children.length;
      const div = document.createElement('div');
      div.className = 'flex gap-2 mb-2';
      div.innerHTML = `
        <input type="text" class="flex-1 border border-gray-300 rounded px-3 py-2" placeholder="Group runner up ${n + 1}">
        <button onclick="removeGroupRunnerUp(this)" class="text-red-500 hover:text-red-700">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>
        </button>`;
      c.appendChild(div);
      div.querySelector('input').addEventListener('input', saveData);
    }
    function removeGroupRunnerUp(btn) {
      if (!isAdmin) return;
      const c = document.getElementById('groupRunnersUp');
      if (c.children.length > 1) { btn.parentElement.remove(); saveData(); }
    }

    function addThirdFourthEliminated() {
      if (!isAdmin) return;
      const c = document.getElementById('thirdFourthEliminated');
      const div = document.createElement('div');
      div.className = 'flex gap-2 mb-2';
      div.innerHTML = `
        <input type="text" class="flex-1 border border-gray-300 rounded px-3 py-2" placeholder="Player eliminated after group">
        <button onclick="removeThirdFourthEliminated(this)" class="text-red-500 hover:text-red-700">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>
        </button>`;
      c.appendChild(div);
      div.querySelector('input').addEventListener('input', saveData);
    }
    function removeThirdFourthEliminated(btn) {
      if (!isAdmin) return;
      const c = document.getElementById('thirdFourthEliminated');
      if (c.children.length > 1) { btn.parentElement.remove(); saveData(); }
    }

    // Highest Checkouts add/remove
    function addHighestCheckouts() {
      if (!isAdmin) return;
      const c = document.getElementById('highestCheckouts');
      const n = c.children.length;
      const div = document.createElement('div');
      div.className = 'flex gap-2 mb-2';
      div.innerHTML = `
        <input type="text" class="flex-1 border border-gray-300 rounded px-3 py-2" placeholder="Highest checkout ${n + 1}">
        <button onclick="removeHighestCheckouts(this)" class="text-red-500 hover:text-red-700">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>
        </button>`;
      c.appendChild(div);
      div.querySelector('input').addEventListener('input', saveData);
    }
    function removeHighestCheckouts(btn) {
      if (!isAdmin) return;
      const c = document.getElementById('highestCheckouts');
      if (c.children.length > 1) { btn.parentElement.remove(); saveData(); }
    }

    // Points calculation
    function calculateAllPoints() {
      const playerPoints = {};
      const playerWeeks = {};

      // Initialize all players found anywhere
      Object.values(weekData).forEach(week => {
        [
          week.winner,
          week.runnerUp,
          ...(week.highestCheckouts || []),
          ...(week.semiFinalists || []),
          ...(week.groupWinners || []),
          ...(week.groupRunnersUp || []),
          ...(week.thirdFourthEliminated || [])
        ].filter(Boolean).forEach(name => {
          const trimmedName = name.trim();
          if (!trimmedName) return;
          if (!playerPoints[trimmedName]) {
            playerPoints[trimmedName] = 0;
            playerWeeks[trimmedName] = new Set();
          }
        });
      });

      // Weekly scoring
      Object.entries(weekData).forEach(([week, data]) => {
        const weekNum = parseInt(week);
        const tournamentPlayers = new Set();

        if (data.winner && data.winner.trim()) {
          const n = data.winner.trim();
          tournamentPlayers.add(n);
          playerPoints[n] += POINTS.tournamentWinner;
          playerWeeks[n].add(weekNum);
        }
        if (data.runnerUp && data.runnerUp.trim()) {
          const n = data.runnerUp.trim();
          tournamentPlayers.add(n);
          playerPoints[n] += POINTS.tournamentRunnerUp;
          playerWeeks[n].add(weekNum);
        }
        (data.semiFinalists || []).forEach(n => {
          if (!n || !n.trim()) return;
          const t = n.trim();
          tournamentPlayers.add(t);
          playerPoints[t] += POINTS.tournamentSemiFinal;
          playerWeeks[t].add(weekNum);
        });

        // Group winners (additive)
        (data.groupWinners || []).forEach(n => {
          if (!n || !n.trim()) return;
          const t = n.trim();
          playerPoints[t] += POINTS.groupWinner;
          playerWeeks[t].add(weekNum);
        });

        // Group runners up (additive)
        (data.groupRunnersUp || []).forEach(n => {
          if (!n || !n.trim()) return;
          const t = n.trim();
          playerPoints[t] += POINTS.groupRunnerUp;
          playerWeeks[t].add(weekNum);
        });

        // Third/Fourth (only if NOT a tournament player)
        (data.thirdFourthEliminated || []).forEach(n => {
          if (!n || !n.trim()) return;
          const t = n.trim();
          if (!tournamentPlayers.has(t)) {
            playerPoints[t] += POINTS.thirdFourthEliminated;
            playerWeeks[t].add(weekNum);
          }
        });

        // Highest checkouts (additive, multiple allowed)
        (data.highestCheckouts || []).forEach(n => {
          if (!n || !n.trim()) return;
          const t = n.trim();
          playerPoints[t] += POINTS.highestCheckout;
          playerWeeks[t].add(weekNum);
        });
      });

      // Attendance bonus (6+ weeks)
      Object.keys(playerPoints).forEach(name => {
        if (playerWeeks[name].size >= 6) playerPoints[name] += POINTS.attendanceBonus;
      });

      return { playerPoints, playerWeeks };
    }

    // League table
    function updateLeagueTable() {
      const { playerPoints, playerWeeks } = calculateAllPoints();
      const leagueTable = Object.entries(playerPoints)
        .map(([name, points]) => ({ name, points, weeksPlayed: playerWeeks[name].size }))
        .sort((a, b) => b.points - a.points || b.weeksPlayed - a.weeksPlayed);

      const tableContainer = document.getElementById('leagueTable');
      if (leagueTable.length === 0) {
        tableContainer.innerHTML = '<p class="text-gray-500 text-center py-8">No data entered yet.</p>';
        return;
      }

      let html = `
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-100">
              <th class="border border-gray-300 px-4 py-2 text-left">Position</th>
              <th class="border border-gray-300 px-4 py-2 text-left">Player</th>
              <th class="border border-gray-300 px-4 py-2 text-center">Total Points</th>
              <th class="border border-gray-300 px-4 py-2 text-center">Weeks Played</th>
              <th class="border border-gray-300 px-4 py-2 text-center">Attendance Bonus</th>
            </tr>
          </thead>
          <tbody>`;
      leagueTable.forEach((p, i) => {
        const emoji = i === 0 ? ' 🏆' : i === 1 ? ' 🥈' : i === 2 ? ' 🥉' : '';
        const rowClass = i < 3 ? 'bg-yellow-50' : 'hover:bg-gray-50';
        const att = p.weeksPlayed >= 6 ? '✅ +3' : '❌';
        html += `
          <tr class="${rowClass}">
            <td class="border border-gray-300 px-4 py-2 font-semibold">${i + 1}${emoji}</td>
            <td class="border border-gray-300 px-4 py-2 font-medium">${p.name}</td>
            <td class="border border-gray-300 px-4 py-2 text-center font-bold">${p.points}</td>
            <td class="border border-gray-300 px-4 py-2 text-center">${p.weeksPlayed}/7</td>
            <td class="border border-gray-300 px-4 py-2 text-center">${att}</td>
          </tr>`;
      });
      html += '</tbody></table>';
      tableContainer.innerHTML = html;
    }

    // CSV Import
    function handleCSVImport(event) {
      if (!isAdmin) return;
      const file = event.target.files[0];
      if (!file) return;

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          try {
            const newWeekData = {};
            results.data.forEach(row => {
              const week = parseInt(row.Week || row.week);
              if (!week || week < 1 || week > 7) return;

              if (!newWeekData[week]) {
                newWeekData[week] = {
                  winner: '',
                  runnerUp: '',
                  semiFinalists: [],
                  groupWinners: [],
                  groupRunnersUp: [],
                  thirdFourthEliminated: [],
                  highestCheckouts: []
                };
              }

              if (row.Winner || row.winner) newWeekData[week].winner = (row.Winner || row.winner).trim();
              if (row.RunnerUp || row.runnerUp || row['Runner Up']) newWeekData[week].runnerUp = (row.RunnerUp || row.runnerUp || row['Runner Up']).trim();

              const s1 = (row.SemiFinalist1 || row.semiFinalist1 || row['Semi Finalist 1'] || '').trim();
              const s2 = (row.SemiFinalist2 || row.semiFinalist2 || row['Semi Finalist 2'] || '').trim();
              newWeekData[week].semiFinalists = [s1, s2].filter(Boolean);

              if (row.GroupWinners || row.groupWinners || row['Group Winners']) {
                newWeekData[week].groupWinners = (row.GroupWinners || row.groupWinners || row['Group Winners']).split(',').map(p => p.trim()).filter(Boolean);
              }
              if (row.GroupRunnersUp || row.groupRunnersUp || row['Group Runners Up']) {
                newWeekData[week].groupRunnersUp = (row.GroupRunnersUp || row.groupRunnersUp || row['Group Runners Up']).split(',').map(p => p.trim()).filter(Boolean);
              }
              if (row.ThirdFourthEliminated || row.thirdFourthEliminated || row['Third Fourth Eliminated']) {
                newWeekData[week].thirdFourthEliminated = (row.ThirdFourthEliminated || row.thirdFourthEliminated || row['Third Fourth Eliminated']).split(',').map(p => p.trim()).filter(Boolean);
              }

              // Accept either "Highest Checkout" (single or comma list) or "Highest Checkouts"
              const hcField = (row.HighestCheckouts || row.highestCheckouts || row['Highest Checkouts'] ||
                               row.HighestCheckout || row.highestCheckout || row['Highest Checkout'] || '').trim();
              if (hcField) {
                newWeekData[week].highestCheckouts = hcField.split(',').map(p => p.trim()).filter(Boolean);
              }
            });

            weekData = { ...weekData, ...newWeekData };
            saveData();
            updateUI();
            alert('CSV imported successfully!');
          } catch (e) {
            alert('Error importing CSV: ' + e.message);
          }
        },
        error: function (error) { alert('Error reading CSV file: ' + error.message); }
      });

      event.target.value = '';
    }

    // CSV Export
    function exportCSV() {
      if (!isAdmin) return;
      const csvData = [];
      for (let week = 1; week <= 7; week++) {
        const data = weekData[week];
        if (data) {
          csvData.push({
            Week: week,
            Winner: data.winner || '',
            'Runner Up': data.runnerUp || '',
            'Semi Finalist 1': (data.semiFinalists && data.semiFinalists[0]) || '',
            'Semi Finalist 2': (data.semiFinalists && data.semiFinalists[1]) || '',
            'Group Winners': (data.groupWinners || []).join(', '),
            'Group Runners Up': (data.groupRunnersUp || []).join(', '),
            'Third Fourth Eliminated': (data.thirdFourthEliminated || []).join(', '),
            // write plural header but remains compatible on re-import
            'Highest Checkouts': (data.highestCheckouts || []).join(', ')
          });
        }
      }
      const csv = Papa.unparse(csvData);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', 'tournament_data.csv');
      link.click();
      URL.revokeObjectURL(url);
    }

    // Clear all data
    function clearAllData() {
      if (!isAdmin) return;
      if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
        weekData = {};
        localStorage.removeItem('tournamentData');
        updateUI();
        alert('All data cleared!');
      }
    }

    // Main input listeners
    document.addEventListener('DOMContentLoaded', function () {
      document.getElementById('winner').addEventListener('input', saveData);
      document.getElementById('runnerUp').addEventListener('input', saveData);
      // no single highestCheckout listener anymore (now list-based)
    });

    // Auto-save on any input
    document.addEventListener('input', function (e) {
      if (isAdmin && e.target.tagName === 'INPUT') saveData();
    });
  </script>
</body>
</html>
